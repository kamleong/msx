#!/bin/sh
# remove '&v=...&t=...' from ${QUERY_STRING}, appended by msx
[ -z "$1" ] && q="${QUERY_STRING%%&*}" || q="$1" ; [ -z "$q" ] && q="songs"
[ "$q" == "img" ] && t="ðŸ–¼scenic/imagesâ›µ" && f="img.txt"
[ "$q" == "mp3" ] && t="ðŸŽ¤mp3ðŸ”‰" && f="mp3.txt"
[ "$q" == "music" ] && t="â™ªéŸ³æ¨‚â™«" && f="music.txt"
[ "$q" == "songs" ] && t="ðŸŽ¤æ­Œæ›²ðŸ”‰" && f="songs.txt"
[ "$q" == "fiction" ] && t="ðŸŽ¬Movies/Series" && f="fiction.txt"
[ "$q" == "plutotv" ] && t="Pluto TV" && f="plutotv.txt"
[ "$q" == "rx" ] && t="" && f="rx.txt"

echo "Content-Type: application/json"
echo ""

cat << EOT
{"ref": "https://msx.benzac.de/wiki/index.php?title=Content_Root_Object",
 "type": "list", "type_": "pages|list", "headline": "$t [$q]",
 "background": "http://161.118.192.255/msx/black.jpg",
 "template": {          
   "type": "separate", "layout": "0,0,1,2", "layout_": "x,y,w,h", "color": "msx-glass",
   "iconSize": "small", "icon": "msx-white-soft:minimize"
 }, "items": [
   {"ref": "https://msx.benzac.de/wiki/index.php?title=Content_Item_Object",
	"title":"âŸ³Refresh","icon":"refresh","action":"[reload:content]"
   }
 , {"title":"ðŸ–¼ Black","action":"[image:https://wallpapercave.com/wp/wp2787656.jpg]"}
EOT

urly="plugin:http://msx.benzac.de/plugins/youtube.html?id="
imgy="https://www.gstatic.com/youtube/img/branding/youtubelogo/svg/youtubelogo.svg"
urld="plugin:http://msx.benzac.de/plugins/dailymotion.html?id"
imgd=""
urlp="http://161.118.192.255/cgi-bin/plutotv.m3u?"
imgp="http://161.118.192.255/cgi-bin/plutotv.png?"

f="/home/opc/msx/$f"; [ -f "$f" ] || f="/dev/null"
# "shuf" vs "sort -R" # significantly slower
shuf "$f" | head -n 100 | while read line 
do
  [ ! -z "$line" ] && [ ${line:0:1} != '#' ] && (
    # "icon":"queue-music" "library-music" "music-video" "music-note"
    # '{print " , {\"title\":\"" $2 "\",\"playerLabel\":\"" $2 " - " $3 "\",\"action\":\"video:" url $1 "\",\"image\":\"" img "\"}" }'
    echo "$line" | awk -F '[\t,|]' -v q="$q" \
      -v autoplay='"focus":true,"execute":true,' \
      -v black='http://161.118.192.255/msx/black.svg' \
      -v urly="$urly" -v imgy="$imgy" \
      -v urld="$urld" -v imgd="$imgd" \
      -v urlp="$urlp" -v imgp="$imgp" \
      '{print " , {" (NR==1?autoplay:"") "\"title\":\"" ($2==""?"â–¤":$2) "\",\"playerLabel\":\"" ($2==""&&$3==""?"":$2" - "$3) "\",\"image\":\""black"\",\"action\":\"" (q=="mp3"?"audio:":(match($1,/\.jpg$/)?"image:":"video:")) (match($1,/^https?:\/\//)?"":(length($1)<=11?urly:urlp))$1 "\",\"image\":\"" ($4==""?(match($1,/^https?:\/\//)?"":(length($1)<=11?imgy:imgp$1)):$4) "\"}" }'
  )
done

cat << EOT
 ]
}
EOT

exit 0
